<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>Iron Track - EL 3ANTEEL</title>

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#050505">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Teko:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  :root {
    --bg-body: #050505;
    --bg-card: #141414;
    --bg-input: #202020;
    --primary: #00e5ff;
    --gold: #ffd700;
    --success: #00ff9d;
    --danger: #ff2a6d;
    
    --font-main: 'Cairo', sans-serif;
    --font-num: 'Teko', sans-serif;
    --radius: 16px;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }

  body {
    background-color: var(--bg-body);
    background-image: radial-gradient(circle at 50% 50%, #1a1a1a 0%, #000 100%);
    color: #e0e0e0;
    font-family: var(--font-main);
    margin: 0; padding: 0;
    min-height: 100vh;
    padding-bottom: 120px;
    overflow-x: hidden;
    padding-top: env(safe-area-inset-top);
  }

  /* Optimize touch response */
  button, .step-btn, .plate-option { touch-action: manipulation; }

  input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

  /* --- ANIMATIONS --- */
  @keyframes shakeHard {
    0% { transform: translate(1px, 1px) rotate(0deg); }
    10% { transform: translate(-1px, -2px) rotate(-1deg); }
    30% { transform: translate(3px, 2px) rotate(0deg); }
    50% { transform: translate(-1px, 2px) rotate(-1deg); }
    100% { transform: translate(1px, -2px) rotate(-1deg); }
  }
  @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
  @keyframes slideUp { 0% { transform: translateY(20px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }

  /* --- HEADER & XP --- */
  header {
    background: rgba(5,5,5,0.95); backdrop-filter: blur(10px);
    position: sticky; top: 0; z-index: 100;
    padding: 0; border-bottom: 1px solid #222;
  }
  .xp-bar-container { width: 100%; height: 6px; background: #111; position: relative; }
  .xp-fill { 
    height: 100%; background: linear-gradient(90deg, var(--primary), #fff); 
    width: 0%; transition: width 1s cubic-bezier(0.22, 1, 0.36, 1); 
    box-shadow: 0 0 10px var(--primary); 
  }
  .header-content { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; }
  .brand-box h1 { margin: 0; font-family: var(--font-num); font-size: 26px; color: #fff; text-transform: uppercase; line-height: 1; letter-spacing: 1px; }
  .rank-display { font-size: 11px; color: var(--gold); font-weight: 700; letter-spacing: 1px; text-transform: uppercase; margin-top: 2px;}

  /* --- TOTAL VOLUME BOX --- */
  .volume-box {
      background: #111; border: 1px solid #333; padding: 5px 10px; border-radius: 6px;
      font-family: var(--font-num); color: #fff; font-size: 16px; display: flex; align-items: center; gap: 5px;
      margin-top: 5px;
  }
  .volume-box i { color: var(--primary); font-size: 12px; }

  /* --- TABS --- */
  .tabs-scroll { overflow-x: auto; padding: 15px 16px; display: flex; gap: 10px; scrollbar-width: none; }
  .tab-btn {
    background: var(--bg-input); color: #777; border: 1px solid #333; 
    padding: 10px 20px; border-radius: 25px; white-space: nowrap;
    font-weight: 600; font-size: 13px; transition: all 0.3s; flex-shrink: 0;
  }
  .tab-btn.active { background: #fff; color: #000; font-weight: 800; transform: scale(1.05); border-color: #fff; box-shadow: 0 0 15px rgba(255,255,255,0.2); }

  /* --- CARDS --- */
  .container { padding: 0 16px; }
  .day-container { display: none; opacity: 0; transition: opacity 0.3s; }
  .day-container.active { display: block; opacity: 1; }

  .card {
    background: var(--bg-card); border-radius: var(--radius); padding: 16px; margin-bottom: 16px;
    border: 1px solid #222; position: relative; overflow: hidden; 
    transition: transform 0.2s; animation: slideUp 0.4s ease-out backwards;
  }
  .card.completed { border-color: rgba(0, 255, 157, 0.3); background: linear-gradient(180deg, #181818, #0a1812); }
  
  .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .ex-title { background: transparent; border: none; color: #fff; font-size: 18px; font-weight: 700; width: 80%; font-family: var(--font-main); }
  .muscle-badge { font-size: 10px; color: #000; background: var(--primary); padding: 2px 6px; border-radius: 4px; font-weight: 700; margin-right: 5px; }
  
  /* Skipped Challenge Badge */
  .skipped-badge { font-size: 10px; color: #000; background: var(--gold); padding: 2px 6px; border-radius: 4px; font-weight: 700; margin-right: 5px; display: none; }
  .skipped-badge.visible { display: inline-block; animation: shakeHard 2s infinite; }

  .sets-row { display: flex; align-items: center; justify-content: space-between; font-size: 12px; color: #777; margin-bottom: 8px; }
  .sets-control-group { display: flex; align-items: center; gap: 8px; background: #222; padding: 2px 8px; border-radius: 20px; border: 1px solid #333; }
  .mini-btn { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; background: transparent; color: #aaa; border: none; font-size: 16px; font-weight: bold; cursor: pointer; }
  .sets-val { color: #fff; font-weight: 700; font-family: var(--font-num); font-size: 16px; }

  .progress-track { height: 6px; background: #222; border-radius: 4px; overflow: hidden; margin-bottom: 14px; }
  .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.4s; }

  /* Controls */
  .controls-grid { display: grid; grid-template-columns: 1fr 1.3fr; gap: 10px; }
  .control-box { background: #1a1a1a; border-radius: 12px; padding: 8px 12px; display: flex; flex-direction: column; gap: 6px; border: 1px solid #2a2a2a; }
  
  /* BOX HEADER FOR 1RM ALIGNMENT */
  .box-header { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 2px; }
  .box-label { font-size: 10px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin: 0; }
  .onerm-disp { font-size: 11px; color: var(--gold); font-family: var(--font-num); font-weight: 700; letter-spacing: 1px; }
  
  .stepper { display: flex; align-items: center; justify-content: space-between; }
  .step-btn { width: 35px; height: 35px; border-radius: 8px; background: #2a2a2a; color: #fff; border: none; font-size: 18px; cursor: pointer; transition: 0.05s; }
  .step-btn:active { transform: scale(0.9); background: #444; }
  .val-disp { font-family: var(--font-num); font-size: 28px; font-weight: 500; background: transparent; border: none; color: #fff; text-align: center; width: 70px; }

  /* --- IRON PLATE DESIGN --- */
  .plate-display-wrapper { display: flex; align-items: center; justify-content: space-between; width: 100%; }
  
  .iron-plate {
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, #444, #111);
    border: 3px solid #555;
    position: relative;
    display: flex; align-items: center;
    justify-content: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.6), inset 0 0 10px rgba(0,0,0,0.8);
    overflow: visible; /* FIX: Allow 3 digits */
  }
  .iron-plate::after { /* The Hole */
    content: ''; position: absolute; 
    top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 25%; height: 25%;
    background: #000; border-radius: 50%;
    border: 2px solid #333; box-shadow: inset 0 0 5px rgba(0,0,0,0.9);
    z-index: 2;
  }
  .plate-text { 
    color: #e0e0e0; font-family: var(--font-num); font-weight: 700; 
    z-index: 3; text-shadow: 1px 1px 2px #000;
    width: 100%; text-align: center; position: absolute;
  }

  /* Main Display Plate */
  .main-plate { width: 75px; height: 75px; }
  .main-plate .plate-text { font-size: 20px; letter-spacing: 0.5px; }

  .add-plate-btn {
    background: #1a1a1a; color: #e0e0e0; border: 1px solid #444;
    padding: 8px 14px; border-radius: 8px; font-size: 11px; font-weight: 700;
    display: flex; align-items: center; gap: 6px; cursor: pointer;
    font-family: var(--font-main); letter-spacing: 0.5px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
  }
  .add-plate-btn:active { transform: scale(0.95); border-color: var(--primary); }

  /* --- CARDIO --- */
  .cardio-timer-box {
    background: #000; border: 1px solid #333; border-radius: 12px; padding: 15px;
    text-align: center; margin-bottom: 15px;
  }
  .timer-big { font-family: var(--font-num); font-size: 40px; color: #fff; margin: 10px 0; letter-spacing: 2px; }
  .cardio-controls { display: flex; gap: 10px; justify-content: center; }
  .cardio-btn { padding: 8px 20px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; font-size: 12px; }
  .c-start { background: var(--success); color: #000; }
  .c-stop { background: var(--danger); color: #fff; }
  .cardio-input { background: #111; border: 1px solid #444; color: #fff; width: 60px; text-align: center; border-radius: 6px; padding: 5px; font-family: var(--font-num); font-size: 18px; }

  /* Actions */
  .actions { display: flex; gap: 10px; margin-top: 15px; }
  .btn-action { 
    flex: 1; padding: 12px; border-radius: 12px; border: none; 
    font-size: 14px; font-weight: 700; font-family: var(--font-main); 
    display: flex; align-items: center; justify-content: center; gap: 8px; 
    cursor: pointer; transition: 0.1s;
  }
  .btn-finish { background: rgba(0, 255, 157, 0.1); color: var(--success); border: 1px solid rgba(0, 255, 157, 0.2); }
  .btn-finish:active { transform: scale(0.98); }
  .btn-finish.active { background: var(--success); color: #000; }

  /* Split Buttons for Challenge */
  .btn-split-success { background: var(--success); color: #000; flex: 2; }
  .btn-split-fail { background: #333; color: #fff; flex: 1; border: 1px solid #555; font-size: 12px; }

  /* --- OVERLAYS --- */
  .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); z-index: 150; opacity: 0; pointer-events: none; transition: 0.3s; display: flex; align-items: center; justify-content: center; }
  .overlay.open { opacity: 1; pointer-events: all; }
  
  .modal { background: #1a1a1a; width: 90%; max-width: 350px; border-radius: 24px; padding: 30px; border: 1px solid #333; text-align: center; transform: scale(0.9); transition: 0.4s; }
  .overlay.open .modal { transform: scale(1); }

  .modal-btn { padding: 14px; border-radius: 14px; border: none; font-weight: 700; width: 100%; font-family: var(--font-main); margin-bottom: 10px; font-size: 15px; cursor: pointer; }
  .btn-danger { background: var(--danger); color: #fff; }
  .btn-outline { background: transparent; border: 1px solid #444; color: #ccc; }

  .btn-shatter { position: relative; overflow: hidden; transition: 0.1s; }
  .btn-shatter.cracked { animation: shakeHard 0.4s ease-in-out; background: #444 !important; color: #bbb !important; }

  .panel { position: fixed; bottom: 0; left: 0; width: 100%; background: #141414; border-radius: 30px 30px 0 0; padding: 30px 25px; z-index: 200; transform: translateY(100%); transition: transform 0.4s; border-top: 1px solid #333; max-height: 85vh; overflow-y: auto;}
  .panel.open { transform: translateY(0); }
  
  .footer-btn { 
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); 
    background: #000; border: 1px solid var(--primary); color: var(--primary); 
    padding: 14px 30px; border-radius: 30px; font-size: 14px; font-weight: 800; 
    z-index: 90; display: flex; gap: 10px; align-items: center; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  }
  .footer-btn:active { transform: translateX(-50%) scale(0.95); }

  .toast-container { position: fixed; top: 110px; left: 50%; transform: translateX(-50%); z-index: 999; pointer-events: none; width: 90%; }
  .toast {
    background: rgba(20, 20, 20, 0.95); border: 1px solid #333; color: #fff; padding: 12px 20px; border-radius: 30px;
    text-align: center; font-weight: 700; font-size: 13px; margin-bottom: 10px; animation: popIn 0.3s;
  }
  
  .rpe-options { display: flex; gap: 10px; margin: 20px 0; }
  .rpe-btn { flex:1; padding: 15px 5px; border-radius: 12px; border: 1px solid #333; background: #0a0a0a; color: #555; font-size: 24px; transition: 0.2s; }
  .rpe-btn.selected { transform: translateY(-5px); border-color: currentColor; background: #222; }

  .input-dark { background: #222; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 8px; width: 100%; font-family: var(--font-main); }
  .switch-row { display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 10px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #333; }
  .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
  .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: var(--danger); }
  input:checked + .slider:before { transform: translateX(20px); }

  /* --- REST TIMER POPUP --- */
  .rest-timer-popup {
    position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(200px);
    background: rgba(10, 10, 10, 0.98); border: 2px solid var(--primary);
    backdrop-filter: blur(10px);
    width: 250px; padding: 20px; border-radius: 20px;
    z-index: 200; text-align: center;
    box-shadow: 0 10px 50px rgba(0,0,0,0.9);
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    pointer-events: none; opacity: 0;
  }
  .rest-timer-popup.visible { transform: translateX(-50%) translateY(0); pointer-events: all; opacity: 1; }
  .rt-time { font-family: var(--font-num); font-size: 50px; color: #fff; line-height: 1; margin: 15px 0; text-shadow: 0 0 20px var(--primary); }
  .rt-close { position: absolute; top: 10px; right: 10px; color: #666; font-size: 20px; cursor: pointer; }
  .rt-label { font-size: 11px; color: var(--primary); letter-spacing: 2px; text-transform: uppercase; font-weight: 700; }

  /* --- MUSCLE GRID (With SVG Icons) --- */
  .muscle-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-height: 400px; overflow-y: auto; }
  .muscle-card {
    background: #222; border: 1px solid #333; border-radius: 12px; padding: 15px;
    display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;
    cursor: pointer; transition: 0.2s; min-height: 100px;
  }
  .muscle-card:active { background: #333; transform: scale(0.97); }
  
  .muscle-icon-svg { 
    width: 70px; height: 70px; background: transparent; 
    display: flex; align-items: center; justify-content: center;
  }
  .muscle-icon-svg svg { width: 100%; height: 100%; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); }
  .muscle-name { font-size: 14px; font-weight: 700; color: #fff; }

  /* --- REAL PLATE GRID --- */
  .plate-mode-switch { display: flex; background: #111; border-radius: 12px; padding: 4px; margin-bottom: 20px; border: 1px solid #333; }
  .mode-opt { flex: 1; padding: 10px; text-align: center; border-radius: 8px; font-size: 14px; font-weight: 700; cursor: pointer; }
  .mode-opt.active.add { background: var(--success); color: #000; }
  .mode-opt.active.sub { background: var(--danger); color: #fff; }

  .plate-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 10px; justify-items: center;}
  
  /* Modal Plate Style - Real Iron Look */
  .modal-plate { 
    width: 65px; height: 65px; 
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, #444, #111);
    border: 2px solid #555;
    position: relative;
    display: flex; align-items: center; justify-content: flex-end;
    padding-right: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.6);
    cursor: pointer; transition: transform 0.1s;
  }
  .modal-plate:active { transform: scale(0.9); }
  .modal-plate::after { 
    content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 25%; height: 25%; background: #000; border-radius: 50%; border: 1px solid #333; 
  }
  .modal-plate .plate-text { font-size: 16px; width: 40%; text-align: center; }

  /* Specific Plate Colors for Modal */
  .p-2_5 { border-color: #777; } .p-2_5 .plate-text { color: #ddd; }
  .p-5 { border-color: #fff; background: radial-gradient(#eee, #999); } .p-5 .plate-text { color: #000; text-shadow:none; }
  .p-10 { border-color: var(--success); } .p-10 .plate-text { color: var(--success); }
  .p-15 { border-color: var(--gold); } .p-15 .plate-text { color: var(--gold); }
  .p-20 { border-color: #0055ff; } .p-20 .plate-text { color: #0055ff; }
  .p-25 { border-color: var(--danger); } .p-25 .plate-text { color: var(--danger); }

  /* CHALLENGE PLATE SELECTOR */
  #challengePlates { display: none; opacity: 0; transition: opacity 0.3s; }
  #challengePlates.visible { display: grid; opacity: 1; }
  #challengeContent { transition: opacity 0.3s; }

</style>
</head>
<body>

<header>
  <div class="xp-bar-container"><div class="xp-fill" id="xpFill"></div></div>
  <div class="header-content">
    <div class="brand-box">
      <h1>IRON TRACK</h1>
      <div class="rank-display" id="rankDisp">LVL 1 â€¢ NEWBIE</div>
      <div class="volume-box" id="volumeDisp">
          <i class="fa-solid fa-weight-hanging"></i> 0 KG
      </div>
      <div style="font-size:10px;color:#777;margin-top:2px" id="userHello"></div>
    </div>
    <div style="color:#fff;font-size:24px;cursor:pointer;padding:5px" onclick="openPanel()"><i class="fa-solid fa-bars"></i></div>
  </div>
</header>

<div class="toast-container" id="toastContainer"></div>

<div class="tabs-scroll" id="tabsContainer"></div>

<main id="appContent" class="container" style="margin-top: 20px;"></main>

<div class="rest-timer-popup" id="restTimerPopup">
  <div class="rt-close" onclick="stopRestTimer()"><i class="fa-solid fa-xmark"></i></div>
  <div class="rt-label">REST TIME</div>
  <div class="rt-time" id="rtDisplay">00:00</div>
  <div style="font-size:11px;color:#555">ÙŠÙ„Ø§ ÙŠØ§ ÙˆØ­Ø´ Ù‚Ø±Ø¨Øª ğŸ”¥</div>
</div>

<button class="footer-btn" onclick="finishSession()">
  <i class="fa-solid fa-check-double"></i> Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©
</button>

<div class="overlay" id="overlay"></div>

<div class="panel" id="panel">
  <div style="display:flex;justify-content:space-between;margin-bottom:25px;color:#fff;font-size:20px;align-items:center;">
    <span style="font-weight:700">ØºØ±ÙØ© Ø§Ù„ØªØ­ÙƒÙ…</span>
    <i class="fa-solid fa-xmark" onclick="closeAll()" style="padding:5px;cursor:pointer"></i>
  </div>
  
  <h3 style="color:#777;font-size:12px;margin-bottom:10px;border-bottom:1px solid #333;padding-bottom:5px">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ø¨ØªÙ†</h3>
  <div style="margin-bottom:20px">
    <label class="label-sec">Ø§Ù„Ø§Ø³Ù…</label>
    <input id="userNameInput" class="input-dark" placeholder="Ø§Ø³Ù…Ùƒ ÙŠØ§ Ø¨Ø·Ù„" onchange="saveProfile()">
    <div style="display:flex; gap:10px; margin-top:10px">
      <div style="flex:1">
        <label class="label-sec">Ø§Ù„Ø³Ù†</label>
        <input type="number" id="userAgeInput" class="input-dark" placeholder="25" onchange="saveProfile()">
      </div>
      <div style="flex:1">
         <label class="label-sec">Ø§Ù„ÙˆØ²Ù† (kg)</label>
         <input type="number" id="userBwInput" class="input-dark" placeholder="80" onchange="saveProfile()">
      </div>
    </div>
  </div>

  <h3 style="color:#777;font-size:12px;margin-bottom:10px;border-bottom:1px solid #333;padding-bottom:5px">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø§Ø­Ø©</h3>
  <div style="margin-bottom:20px">
    <label class="label-sec">ÙˆÙ‚Øª Ø§Ù„Ø±Ø§Ø­Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ø«ÙˆØ§Ù†ÙŠ)</label>
    <input type="number" id="restTimeSetting" class="input-dark" value="180" onchange="saveSettings()">
  </div>

  <h3 style="color:#777;font-size:12px;margin-bottom:10px;border-bottom:1px solid #333;padding-bottom:5px">Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</h3>
  <div class="switch-row">
    <div>
      <div style="font-size:14px;font-weight:700;color:var(--danger)">ÙˆØ¶Ø¹ Ø§Ù„Ø¥ØµØ§Ø¨Ø© ğŸš‘</div>
      <div style="font-size:11px;color:#777">ÙØ¹Ù„ Ø¯Ù‡ Ù„Ùˆ Ù…ØµØ§Ø¨ Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ XP Ù…ÙŠØªÙ…Ø³Ø­Ø´</div>
    </div>
    <label class="switch">
      <input type="checkbox" id="injuryToggle" onchange="toggleInjury()">
      <span class="slider"></span>
    </label>
  </div>

  <h3 style="color:#777;font-size:12px;margin-bottom:10px;margin-top:20px;border-bottom:1px solid #333;padding-bottom:5px">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†</h3>
  <button class="modal-btn" onclick="openMuscleMenu()" style="background:var(--primary);color:#000;font-weight:800">ØªÙ…Ø±ÙŠÙ† Ø¬Ø¯ÙŠØ¯ +</button>
  <button class="modal-btn btn-outline" onclick="addBulk()" style="font-size:13px">Ø¥Ø¶Ø§ÙØ© 5 ØªÙ…Ø§Ø±ÙŠÙ† ÙØ§Ø±ØºØ©</button>

  <h3 style="color:#777;font-size:12px;margin-bottom:10px;margin-top:20px">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙŠØ§Ù…</h3>
  <div class="day-mgmt-row">
    <input id="newDayName" class="input-dark" placeholder="Ø§Ø³Ù… Ø§Ù„ÙŠÙˆÙ…">
    <button class="modal-btn" style="width:auto;margin:0;background:#333;color:#fff" onclick="addNewDay()"><i class="fa-solid fa-plus"></i></button>
  </div>
  <div class="day-mgmt-row">
     <button class="modal-btn btn-outline" onclick="renameCurrentDay()" style="font-size:12px">ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…</button>
     <button class="modal-btn btn-danger" onclick="deleteCurrentDay()" style="font-size:12px;width:80px"><i class="fa-solid fa-trash"></i></button>
  </div>

  <div style="text-align:center;margin-top:30px;color:#444;font-size:12px" onclick="clearAll()">RESET ALL DATA</div>
</div>

<div class="overlay" id="modalMuscle">
  <div class="modal">
    <div style="color:#fff;font-size:20px;font-weight:700;margin-bottom:5px">Ø§Ø®ØªØ§Ø± Ø§Ù„Ø¹Ø¶Ù„Ø© ğŸ’ª</div>
    <div id="muscleBreadcrumb" style="font-size:12px;color:var(--primary);margin-bottom:15px;display:none" onclick="renderMainMuscles()"> <i class="fa-solid fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
    <div class="muscle-grid" id="muscleGrid"></div>
    <button class="modal-btn btn-outline" style="margin-top:15px" onclick="closeMuscleMenu()">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<div class="overlay" id="modalPlates">
  <div class="modal">
    <div style="color:#fff;font-size:18px;font-weight:700;margin-bottom:15px">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ²Ù†</div>
    
    <div class="plate-mode-switch">
      <div class="mode-opt active add" id="modeAdd" onclick="setPlateMode(1)">ØªØ²ÙˆÙŠØ¯ +</div>
      <div class="mode-opt" id="modeSub" onclick="setPlateMode(-1)">ØªÙ†Ù‚ÙŠØµ -</div>
    </div>
    
    <div class="plate-grid">
      <div class="modal-plate p-2_5" onclick="addPlateWeight(2.5)"><span class="plate-text">2.5</span></div>
      <div class="modal-plate p-5" onclick="addPlateWeight(5)"><span class="plate-text">5</span></div>
      <div class="modal-plate p-10" onclick="addPlateWeight(10)"><span class="plate-text">10</span></div>
      <div class="modal-plate p-15" onclick="addPlateWeight(15)"><span class="plate-text">15</span></div>
      <div class="modal-plate p-20" onclick="addPlateWeight(20)"><span class="plate-text">20</span></div>
      <div class="modal-plate p-25" onclick="addPlateWeight(25)"><span class="plate-text">25</span></div>
    </div>

    <div style="margin-top:20px; display:flex; gap:10px">
      <button class="modal-btn btn-outline" onclick="closePlates()">Ø¥ØºÙ„Ø§Ù‚</button>
      <button class="modal-btn btn-danger" onclick="resetWeight()" style="flex:1">ØªØµÙÙŠØ± Ø§Ù„ÙˆØ²Ù†</button>
    </div>
  </div>
</div>

<div class="overlay" id="modalChallenge">
  <div class="modal">
    <div style="font-size:60px;margin-bottom:10px">ğŸ˜¤</div>
    
    <div id="challengeContent">
        <div style="color:#fff;font-size:22px;font-weight:800;margin-bottom:5px">Ù‡ØªØ¹Ø±Ù ØªÙƒØ³Ø± Ø§Ù„ÙˆØ²Ù† ÙŠØ¹Ù†ØªÙŠÙ„ğŸ˜¤</div>
        <div id="challengeQuote" style="color:#aaa;margin-bottom:25px;font-size:14px;line-height:1.4"></div>
        <button class="modal-btn btn-danger btn-shatter" id="btnShatter" onclick="handleShatter(this)">Ù‡ÙƒØ³Ø± Ø§Ù…ÙˆğŸ¥µğŸ¦</button>
        <button class="modal-btn btn-outline" onclick="declineChallenge()">Ù…Ø´ Ø§Ù†Ù‡Ø§Ø±Ø¯Ø©</button>
    </div>

    <div id="challengePlates" class="plate-grid">
        <div style="grid-column:1/-1;color:#fff;margin-bottom:10px;font-weight:700">Ù‡ØªØ²ÙˆØ¯ ÙƒØ§Ù… ÙŠØ§ ÙˆØ­Ø´ØŸ ğŸ”¥</div>
        <div class="modal-plate p-2_5" onclick="confirmChallengeWeight(2.5)"><span class="plate-text">2.5</span></div>
        <div class="modal-plate p-5" onclick="confirmChallengeWeight(5)"><span class="plate-text">5</span></div>
        <div class="modal-plate p-10" onclick="confirmChallengeWeight(10)"><span class="plate-text">10</span></div>
    </div>

  </div>
</div>

<div class="overlay" id="modalWizard">
  <div class="modal">
    <div style="color:#fff;font-size:20px;font-weight:700">Ø®Ù„ØµØª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©ØŸ</div>
    <p style="color:#777;font-size:12px;margin-bottom:20px">Ù‚ÙŠÙ… ØµØ¹ÙˆØ¨Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡</p>
    <div class="rpe-options">
      <button class="rpe-btn" onclick="selectRPE('easy', this)" style="color:var(--success)"><i class="fa-regular fa-face-laugh-beam"></i></button>
      <button class="rpe-btn" onclick="selectRPE('medium', this)" style="color:var(--gold)"><i class="fa-regular fa-face-meh"></i></button>
      <button class="rpe-btn" onclick="selectRPE('hard', this)" style="color:var(--danger)"><i class="fa-solid fa-face-tired"></i></button>
    </div>
    <div style="display:flex;gap:10px;margin-bottom:15px">
      <button class="modal-btn btn-outline" id="btnFormBad" onclick="selectForm(false)" style="font-size:12px">â— ÙÙˆØ±Ù… Ø³ÙŠØ¡</button>
      <button class="modal-btn btn-outline" id="btnFormGood" onclick="selectForm(true)" style="font-size:12px">âœ”ï¸ ÙÙˆØ±Ù… Ù…Ø³Ø·Ø±Ø©</button>
    </div>
    <button class="modal-btn" style="background:var(--primary);color:#000" onclick="submitWizard()">Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù…</button>
  </div>
</div>

<div class="overlay" id="modalTips">
  <div class="modal">
    <div style="font-size:50px;margin-bottom:10px">ğŸ›€</div>
    <div style="color:#fff;font-size:22px;font-weight:800;margin-bottom:10px">Ø¹Ø§Ø´ ÙŠØ§ ÙˆØ­Ø´!</div>
    <p id="tipText" style="color:#ccc;font-size:14px;line-height:1.6;margin-bottom:20px"></p>
    <button class="modal-btn" style="background:#fff;color:#000" onclick="closeTips()">ØªÙ…Ø§Ù… ÙŠØ§ Ù†Ø¬Ù…â¤ï¸ğŸ˜‰</button>
  </div>
</div>

<div class="overlay" id="modalWipeout">
  <div class="modal" style="border-color:var(--danger)">
    <div style="font-size:60px;margin-bottom:10px">ğŸ’€</div>
    <div style="color:var(--danger);font-size:22px;font-weight:800;margin-bottom:10px">Game Over!</div>
    <p style="color:#ccc;font-size:14px;line-height:1.6;margin-bottom:20px">
      ÙØ§Øª 7 Ø£ÙŠØ§Ù… Ù…Ù† ØºÙŠØ± ØªÙ…Ø±ÙŠÙ† ÙŠØ§ ÙˆØ­Ø´.<br>
      ÙƒÙ„ Ø§Ù„Ù€ XP Ø§Ù„Ù„ÙŠ Ø¬Ù…Ø¹ØªÙ‡ Ø±Ø§Ø­.<br>
      Ø§Ø¨Ø¯Ø§ Ù…Ù† Ø¬Ø¯ÙŠØ¯ ÙˆÙ…ØªØ®Ù„ÙŠØ´ Ø­Ø§Ø¬Ø© ØªÙˆÙ‚ÙÙƒ!
    </p>
    <button class="modal-btn btn-outline" onclick="closeWipeout()">Ù…Ø§Ø´ÙŠØŒ Ù‡Ø¹ÙˆØ¶Ù‡Ø§ ğŸ’ª</button>
  </div>
</div>

<script>
// --- ANATOMY ICONS (SVG PATHS) ---
// Using constructed SVG strings to avoid external requests
const ANATOMY_ICONS = {
    chest: {
        base: '<path d="M20,30 Q50,15 80,30 L80,60 Q50,85 20,60 Z" fill="#333" stroke="#555" stroke-width="2"/>',
        upper: '<path d="M20,30 Q50,15 80,30 L80,40 Q50,30 20,40 Z" fill="#ff2a6d" opacity="0.8"/>',
        mid:   '<path d="M20,40 Q50,30 80,40 L80,50 Q50,45 20,50 Z" fill="#ff2a6d" opacity="0.8"/>',
        lower: '<path d="M20,50 Q50,45 80,50 L80,60 Q50,85 20,60 Z" fill="#ff2a6d" opacity="0.8"/>'
    },
    back: {
        base: '<path d="M20,20 L80,20 L60,80 L40,80 Z" fill="#333" stroke="#555" stroke-width="2"/>',
        lats: '<path d="M20,20 L35,20 L40,80 L60,80 L65,20 L80,20 L60,80 L40,80 Z" fill="transparent" stroke="transparent"/> <path d="M20,20 L30,20 L45,60 L20,20 Z M80,20 L70,20 L55,60 L80,20 Z" fill="#ff2a6d" opacity="0.8"/>', // Simplified Lats
        traps: '<path d="M35,20 L65,20 L50,45 Z" fill="#ff2a6d" opacity="0.8"/>',
        lower: '<path d="M40,60 L60,60 L60,80 L40,80 Z" fill="#ff2a6d" opacity="0.8"/>'
    },
    arm: {
        base: '<circle cx="50" cy="30" r="15" fill="#333" stroke="#555"/><rect x="40" y="45" width="20" height="40" rx="5" fill="#333" stroke="#555"/>',
        bicep: '<circle cx="40" cy="35" r="8" fill="#ff2a6d" opacity="0.8"/>',
        tricep: '<circle cx="60" cy="35" r="8" fill="#ff2a6d" opacity="0.8"/>',
        forearm: '<rect x="42" y="50" width="16" height="30" fill="#ff2a6d" opacity="0.8"/>'
    },
    shoulder: {
        base: '<path d="M20,30 Q50,10 80,30 L70,50 Q50,40 30,50 Z" fill="#333" stroke="#555"/>',
        front: '<circle cx="35" cy="35" r="10" fill="#ff2a6d" opacity="0.8"/>',
        side: '<circle cx="50" cy="30" r="10" fill="#ff2a6d" opacity="0.8"/>',
        rear: '<circle cx="65" cy="35" r="10" fill="#ff2a6d" opacity="0.8"/>'
    },
    leg: {
        base: '<path d="M30,10 L70,10 L65,50 L35,50 Z M35,55 L65,55 L60,90 L40,90 Z" fill="#333" stroke="#555"/>',
        quads: '<path d="M30,10 L70,10 L65,50 L35,50 Z" fill="#ff2a6d" opacity="0.8"/>',
        hams: '<path d="M30,10 L70,10 L65,50 L35,50 Z" fill="#ff2a6d" opacity="0.5"/>', // Back of thigh
        calves: '<path d="M35,55 L65,55 L60,90 L40,90 Z" fill="#ff2a6d" opacity="0.8"/>'
    }
};

const MUSCLES = {
  main: [
    { id: 'chest', name: 'ØµØ¯Ø±', icon: 'fa-child-reaching' },
    { id: 'back', name: 'Ø¸Ù‡Ø±', icon: 'fa-person' },
    { id: 'arm', name: 'Ø°Ø±Ø§Ø¹', icon: 'fa-hand-fist' },
    { id: 'shoulder', name: 'Ø£ÙƒØªØ§Ù', icon: 'fa-arrows-left-right-to-line' },
    { id: 'legs', name: 'Ø£Ø±Ø¬Ù„', icon: 'fa-person-running' },
    { id: 'cardio', name: 'ÙƒØ§Ø±Ø¯ÙŠÙˆ', icon: 'fa-heart-pulse' }
  ],
  sub: {
    chest: [
      { name: 'ØµØ¯Ø± Ø¹Ù„ÙˆÙŠ', svgType: 'chest', highlight: 'upper' },
      { name: 'ØµØ¯Ø± Ù…Ø³ØªÙˆÙŠ', svgType: 'chest', highlight: 'mid' },
      { name: 'ØµØ¯Ø± Ø³ÙÙ„ÙŠ', svgType: 'chest', highlight: 'lower' }
    ],
    back: [
      { name: 'Ù„Ø§ØªØ³ (Lats)', svgType: 'back', highlight: 'lats' },
      { name: 'ØªØ±Ø§Ø¨ÙŠØ³ (Traps)', svgType: 'back', highlight: 'traps' },
      { name: 'Ù‚Ø·Ù†ÙŠØ© (Lower)', svgType: 'back', highlight: 'lower' }
    ],
    arm: [
      { name: 'Ø¨Ø§ÙŠØ³Ø¨Ø³', svgType: 'arm', highlight: 'bicep' },
      { name: 'ØªØ±Ø§ÙŠØ³ÙŠØ¨Ø³', svgType: 'arm', highlight: 'tricep' },
      { name: 'Ù‡Ø§Ù…Ø±', svgType: 'arm', highlight: 'bicep' },
      { name: 'Ø³ÙˆØ§Ø¹Ø¯', svgType: 'arm', highlight: 'forearm' }
    ],
    shoulder: [
      { name: 'ÙƒØªÙ Ø£Ù…Ø§Ù…ÙŠ', svgType: 'shoulder', highlight: 'front' },
      { name: 'ÙƒØªÙ Ø¬Ø§Ù†Ø¨ÙŠ', svgType: 'shoulder', highlight: 'side' },
      { name: 'ÙƒØªÙ Ø®Ù„ÙÙŠ', svgType: 'shoulder', highlight: 'rear' }
    ],
    legs: [
      { name: 'Ø£Ù…Ø§Ù…ÙŠØ© (Quads)', svgType: 'leg', highlight: 'quads' },
      { name: 'Ø®Ù„ÙÙŠØ© (Hams)', svgType: 'leg', highlight: 'hams' },
      { name: 'Ø³Ù…Ø§Ù†Ø© (Calves)', svgType: 'leg', highlight: 'calves' }
    ]
  }
};

// --- CONFIG ---
const KEY = 'iron_track_final_v14';
const XP_KEY = 'iron_track_xp_v14';
const PR_KEY = 'iron_track_prs_v14';
const DAYS_KEY = 'iron_track_days_v14';
const PROFILE_KEY = 'iron_track_profile_v14';
const SETTINGS_KEY = 'iron_track_settings_v14';

// --- STATE ---
let data = [[],[],[],[]];
let dayNames = ["Day 1", "Day 2", "Day 3", "Day 4"];
let userStats = { xp: 0, lastLogin: Date.now(), isInjured: false };
let userProfile = { name: '', age: '', weight: '' };
let appSettings = { restTime: 180 };
let personalRecords = {};
let curDay = 0;
let tempWizardData = { idx: -1, rpe: null, form: true }; 
let challengeState = 0;
let currentWeightEditIdx = -1; 
let plateMode = 1;

// SAVE TIMER (DEBOUNCE)
let saveTimer = null;

const RANKS = [
  { limit: 0, title: "Newbie ğŸ£" },
  { limit: 2500, title: "Gecko ğŸ¦" },
  { limit: 7500, title: "Snake ğŸ" },
  { limit: 15000, title: "Wolf ğŸº" },
  { limit: 30000, title: "Bear ğŸ»" },
  { limit: 50000, title: "Gorilla ğŸ¦" },
  { limit: 90000, title: "Rhino ğŸ¦" },
  { limit: 150000, title: "T-Rex ğŸ¦–" },
  { limit: 250000, title: "KAIJU ğŸ‘¹" },
  { limit: 400000, title: "DRAGON ğŸ‰" }
];

const TIPS = [
  "Ø§Ù„Ù†ÙˆÙ… 8 Ø³Ø§Ø¹Ø§Øª Ù‡Ùˆ Ø§Ù„Ø³ØªÙŠØ±ÙˆÙŠØ¯ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ Ø¨ØªØ§Ø¹Ùƒ. Ù†Ø§Ù… ÙƒÙˆÙŠØ³!",
  "Ø§Ø´Ø±Ø¨ Ù…ÙŠØ© ÙƒØªÙŠØ±ØŒ Ø¹Ø¶Ù„Ø§ØªÙƒ 70% Ù…Ù†Ù‡Ø§ Ù…ÙŠØ©.",
  "Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ† Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ† Ù…Ù‡Ù…ØŒ Ø¨Ø³ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ† ÙÙŠ Ø§Ù„ÙŠÙˆÙ… Ø£Ù‡Ù….",
  "Ø§Ù„ÙƒØ§Ø±Ø¯ÙŠÙˆ Ø§Ù„Ø®ÙÙŠÙ Ø¨ÙŠØ³Ø§Ø¹Ø¯ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ´ÙØ§Ø¡ ÙˆØ¨ÙŠÙ‚Ù„Ù„ Ø§Ù„ÙˆØ¬Ø¹.",
];

// --- INIT ---
function load(){
  if(localStorage.getItem(KEY)) data = JSON.parse(localStorage.getItem(KEY));
  if(localStorage.getItem(XP_KEY)) userStats = JSON.parse(localStorage.getItem(XP_KEY));
  if(localStorage.getItem(PR_KEY)) personalRecords = JSON.parse(localStorage.getItem(PR_KEY));
  if(localStorage.getItem(DAYS_KEY)) dayNames = JSON.parse(localStorage.getItem(DAYS_KEY));
  if(localStorage.getItem(PROFILE_KEY)) userProfile = JSON.parse(localStorage.getItem(PROFILE_KEY));
  if(localStorage.getItem(SETTINGS_KEY)) appSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY));
  
  if(userStats.isInjured === undefined) userStats.isInjured = false;
  if(userStats.lastLogin === undefined) userStats.lastLogin = Date.now();

  checkStreak();
  while(data.length < dayNames.length) data.push([]);
  
  document.getElementById('userNameInput').value = userProfile.name || '';
  document.getElementById('userAgeInput').value = userProfile.age || '';
  document.getElementById('userBwInput').value = userProfile.weight || '';
  document.getElementById('injuryToggle').checked = userStats.isInjured;
  document.getElementById('restTimeSetting').value = appSettings.restTime || 180;

  updateUserHello();
  renderTabs();
  updateXPUI();
  render();
  calculateVolume();
}

function save(){ 
  localStorage.setItem(KEY, JSON.stringify(data));
  localStorage.setItem(XP_KEY, JSON.stringify(userStats));
  localStorage.setItem(PR_KEY, JSON.stringify(personalRecords));
  localStorage.setItem(DAYS_KEY, JSON.stringify(dayNames));
  localStorage.setItem(PROFILE_KEY, JSON.stringify(userProfile));
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
}

function debouncedSave() {
  clearTimeout(saveTimer);
  saveTimer = setTimeout(save, 1000);
}

// --- TOTAL VOLUME LOGIC (TODAY) ---
function calculateVolume() {
    let total = 0;
    if(data[curDay]) {
        data[curDay].forEach(ex => {
            if(ex.type !== 'cardio') {
                total += (ex.weight * ex.reps * ex.done);
            }
        });
    }
    document.getElementById('volumeDisp').innerHTML = `<i class="fa-solid fa-weight-hanging"></i> ${total.toLocaleString()} KG`;
}

// --- STREAK & PROFILE ---
function checkStreak() {
  const now = Date.now();
  const diffTime = Math.abs(now - userStats.lastLogin);
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
  if (diffDays > 7 && !userStats.isInjured && userStats.xp > 0) {
    userStats.xp = 0; save();
    document.getElementById('modalWipeout').classList.add('open');
  }
  userStats.lastLogin = now; save();
}
function closeWipeout() { document.getElementById('modalWipeout').classList.remove('open'); updateXPUI(); }
function toggleInjury() { userStats.isInjured = document.getElementById('injuryToggle').checked; save(); showToast(userStats.isInjured ? "Ø£Ù„Ù Ø³Ù„Ø§Ù…Ø© â¤ï¸" : "Ø­Ù…Ø¯Ø§Ù„Ù„Ù‡ Ø¹ Ø§Ù„Ø³Ù„Ø§Ù…Ø©"); }
function saveProfile() {
  userProfile.name = document.getElementById('userNameInput').value;
  userProfile.age = document.getElementById('userAgeInput').value;
  userProfile.weight = document.getElementById('userBwInput').value;
  save(); updateUserHello();
}
function saveSettings() {
  appSettings.restTime = parseInt(document.getElementById('restTimeSetting').value) || 180;
  save();
}
function updateUserHello() {
  const div = document.getElementById('userHello');
  if(userProfile.name) div.innerText = `Ø£Ù‡Ù„Ø§ ÙŠØ§ ÙƒØ§Ø¨ØªÙ† ${userProfile.name.split(' ')[0]} ğŸ‘‹`;
}

// --- MAIN RENDER ---
function renderTabs() {
  const c = document.getElementById('tabsContainer');
  c.innerHTML = '';
  dayNames.forEach((name, i) => {
    const btn = document.createElement('button');
    btn.className = `tab-btn ${i === curDay ? 'active' : ''}`;
    btn.innerText = name;
    btn.onclick = () => { switchDay(i); };
    c.appendChild(btn);
  });
}
function switchDay(i){ curDay = i; renderTabs(); render(); calculateVolume(); }

function render(){
  const c = document.getElementById('appContent');
  c.innerHTML = '';
  const dayDiv = document.createElement('div');
  dayDiv.className = 'day-container active';
  
  if(data[curDay].length === 0) {
    dayDiv.innerHTML = `<div style="text-align:center;padding:60px 20px;color:#444"><i class="fa-solid fa-dumbbell" style="font-size:50px;margin-bottom:15px;opacity:0.5"></i><br>ÙŠÙˆÙ…Ùƒ ÙØ§Ø¶ÙŠ ÙŠØ§ ÙˆØ­Ø´.</div>`;
  } else {
    data[curDay].forEach((ex, i) => {
      // CARDIO RENDER
      if(ex.type === 'cardio') {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="card-header">
             <div style="display:flex;align-items:center;gap:10px">
               <span class="muscle-badge">CARDIO</span>
               <input class="ex-title" value="${ex.name}" onchange="upd(${i},'name',this.value)">
             </div>
             <i class="fa-solid fa-trash" style="color:#444;cursor:pointer" onclick="del(${i})"></i>
          </div>
          <div class="cardio-timer-box">
             <div style="color:#777;font-size:12px;margin-bottom:5px">TIMER</div>
             <div class="timer-big" id="cardio-timer-${i}">00:00</div>
             <div class="cardio-controls">
                <button class="cardio-btn c-start" onclick="toggleCardio(${i})">START / PAUSE</button>
                <input type="number" class="cardio-input" placeholder="Min" id="cardio-set-${i}" value="${ex.targetTime||10}" onchange="upd(${i},'targetTime',this.value)">
             </div>
          </div>
        `;
        dayDiv.appendChild(card);
        return; 
      }

      // STRENGTH RENDER
      const isDone = ex.done >= ex.target;
      const pct = Math.min(100, (ex.done/ex.target)*100);
      let dotColor = '';
      if(ex.rpeVal === 'easy') dotColor = 'var(--success)';
      if(ex.rpeVal === 'medium') dotColor = 'var(--gold)';
      if(ex.rpeVal === 'hard') dotColor = 'var(--danger)';
      
      // Calculate 1RM (Epley)
      let oneRM = 0;
      if(ex.weight > 0 && ex.reps > 0) {
        oneRM = Math.round(ex.weight * (1 + ex.reps / 30));
      }

      const card = document.createElement('div');
      card.className = `card ${isDone?'completed':''}`;
      card.id = `c-${i}`;
      
      card.innerHTML = `
        ${dotColor ? `<div style="width:8px;height:8px;border-radius:50%;background:${dotColor};position:absolute;top:15px;left:15px;box-shadow:0 0 8px ${dotColor}"></div>` : ''}

        <div class="card-header">
          <div style="display:flex;align-items:center;gap:10px;width:80%">
             ${ex.muscle ? `<span class="muscle-badge">${ex.muscle}</span>` : ''}
             ${ex.skippedChallenge ? `<span class="skipped-badge visible" title="ØªØ­Ø¯ÙŠ ÙØ§ØªÙƒ">âš ï¸</span>` : ''}
             <input class="ex-title" value="${ex.name}" onchange="upd(${i},'name',this.value)">
          </div>
          <i class="fa-solid fa-trash" style="color:#444;padding:10px" onclick="del(${i})"></i>
        </div>
        
        <div class="sets-row">
          <span>${isDone ? 'ØªÙ…Øª Ø§Ù„Ù…Ù‡Ù…Ø©' : 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª'}</span>
          <div class="sets-control-group">
            <button class="mini-btn" onclick="modTarget(${i}, -1)">-</button>
            <div class="sets-display sets-val" id="sets-disp-${i}">${ex.done} <span style="color:#555">/</span> ${ex.target}</div>
            <button class="mini-btn" onclick="modTarget(${i}, 1)">+</button>
          </div>
        </div>
        <div class="progress-track"><div class="progress-fill" id="prog-fill-${i}" style="width:${pct}%"></div></div>

        <div class="controls-grid">
          <div class="control-box">
            <div class="box-label">Reps</div>
            <div class="stepper">
              <button class="step-btn" onclick="mod(${i},'reps',-1)">-</button>
              <input class="val-disp" id="reps-val-${i}" type="number" value="${ex.reps}" onchange="checkRepsInput(${i}, this.value)">
              <button class="step-btn" onclick="mod(${i},'reps',1)">+</button>
            </div>
          </div>
          
          <div class="control-box">
            <div class="box-header">
               <span class="box-label">Weight (KG)</span>
               <span class="onerm-disp" id="rm-disp-${i}">1RM: ${oneRM}kg</span>
            </div>
            <div class="plate-display-wrapper">
              <div class="iron-plate main-plate" id="w-disp-${i}">
                 <span class="plate-text" id="w-text-${i}">${ex.weight}</span>
              </div>
              <button class="add-plate-btn" onclick="openPlateRack(${i})">
                 KG +/-
              </button>
            </div>
          </div>
        </div>
        
        <div class="actions" id="action-container-${i}">
           ${renderActionButtons(ex, i, isDone)}
        </div>
      `;
      dayDiv.appendChild(card);
    });
  }
  c.appendChild(dayDiv);
}

// HELPER FOR SPLIT BUTTONS
function renderActionButtons(ex, i, isDone) {
    if (ex.challengeActive) {
        return `
            <div style="display:flex;gap:10px;width:100%">
                <button class="btn-action btn-split-success" onclick="successChallenge(${i})">
                    <i class="fa-solid fa-check"></i> Ø¹Ø§Ø´ Ø³Ø¬Ù„
                </button>
                <button class="btn-action btn-split-fail" onclick="failChallenge(${i})">
                    <i class="fa-solid fa-xmark"></i> Ù…Ù‚Ø¯Ø±ØªØ´
                </button>
            </div>
        `;
    } else {
        return `
            <button class="btn-action btn-finish ${isDone?'active':''}" onclick="addSet(${i})" id="btn-finish-${i}">
                ${isDone ? '<i class="fa-solid fa-check"></i>' : 'ØªØ³Ø¬ÙŠÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø©'}
            </button>
        `;
    }
}


// --- LOGIC (LAG FREE) ---
function upd(i,f,v){
  if(f!=='name') v=parseFloat(v)||0;
  data[curDay][i][f]=v; debouncedSave(); 
}

// PERFORMANCE FIX: Update DOM directly without re-render
function modTarget(i, d) {
  let v = data[curDay][i].target || 3; v += d; if (v < 1) v = 1;
  data[curDay][i].target = v; save();
  
  // Direct DOM Update
  document.getElementById(`sets-disp-${i}`).innerHTML = `${data[curDay][i].done} <span style="color:#555">/</span> ${v}`;
  updateProgressBar(i);
}

function mod(i,f,d){
  let v = data[curDay][i][f]||0; v+=d; if(v<0)v=0;
  data[curDay][i][f]=v; 
  debouncedSave(); 
  
  // Direct DOM Update
  if(f === 'reps') {
      document.getElementById(`reps-val-${i}`).value = v;
      checkRepTrigger(i, v);
      update1RM(i);
      calculateVolume();
  }
}

function update1RM(i) {
  const ex = data[curDay][i];
  if(!ex) return;
  const oneRM = Math.round(ex.weight * (1 + ex.reps / 30));
  const el = document.getElementById(`rm-disp-${i}`);
  if(el) el.innerText = `1RM: ${oneRM}kg`;
}

function checkRepsInput(i,v){ upd(i,'reps',v); checkRepTrigger(i,parseFloat(v)); update1RM(i); calculateVolume(); }

// PLATE SYSTEM LOGIC (LAG FREE)
function openPlateRack(i) {
  currentWeightEditIdx = i;
  setPlateMode(1);
  document.getElementById('modalPlates').classList.add('open');
}
function setPlateMode(m) {
  plateMode = m;
  const addBtn = document.getElementById('modeAdd');
  const subBtn = document.getElementById('modeSub');
  if(m === 1) { addBtn.classList.add('active', 'add'); subBtn.classList.remove('active', 'sub'); } 
  else { addBtn.classList.remove('active', 'add'); subBtn.classList.add('active', 'sub'); }
}
function closePlates() { document.getElementById('modalPlates').classList.remove('open'); currentWeightEditIdx = -1; }
function addPlateWeight(val) {
  if (currentWeightEditIdx === -1) return;
  const delta = val * plateMode;
  let currentW = data[curDay][currentWeightEditIdx].weight || 0;
  currentW += delta; if(currentW < 0) currentW = 0;
  data[curDay][currentWeightEditIdx].weight = currentW;
  save();
  
  // Direct DOM Update
  document.getElementById(`w-text-${currentWeightEditIdx}`).innerText = currentW;
  update1RM(currentWeightEditIdx);
  calculateVolume();
  
  showToast(`ØªÙ… ${plateMode===1?'Ø¥Ø¶Ø§ÙØ©':'Ø®ØµÙ…'} ${val} ÙƒØ¬Ù…`);
}
function resetWeight() {
  if (currentWeightEditIdx === -1) return;
  if(confirm("ØªØµÙÙŠØ± Ø§Ù„ÙˆØ²Ù†ØŸ")) {
    data[curDay][currentWeightEditIdx].weight = 0; save();
    document.getElementById(`w-text-${currentWeightEditIdx}`).innerText = 0;
    update1RM(currentWeightEditIdx);
    calculateVolume();
    closePlates();
  }
}

// MUSCLE MENU LOGIC
function openMuscleMenu() {
  closeAll();
  renderMainMuscles();
  document.getElementById('modalMuscle').classList.add('open');
}
function closeMuscleMenu() { document.getElementById('modalMuscle').classList.remove('open'); }

function renderMainMuscles() {
  const grid = document.getElementById('muscleGrid');
  const bread = document.getElementById('muscleBreadcrumb');
  bread.style.display = 'none';
  grid.innerHTML = '';
  
  MUSCLES.main.forEach(m => {
    const el = document.createElement('div');
    el.className = 'muscle-card';
    el.innerHTML = `<div class="muscle-icon-svg"><i class="fa-solid ${m.icon}" style="font-size:40px;color:#777"></i></div><span class="muscle-name">${m.name}</span>`;
    el.onclick = () => {
      if(m.id === 'cardio') {
        addExercise('ÙƒØ§Ø±Ø¯ÙŠÙˆ', 'cardio', 'cardio');
      } else {
        renderSubMuscles(m.id);
      }
    };
    grid.appendChild(el);
  });
}

function renderSubMuscles(mainId) {
  const grid = document.getElementById('muscleGrid');
  const bread = document.getElementById('muscleBreadcrumb');
  bread.style.display = 'block';
  grid.innerHTML = '';
  
  const subs = MUSCLES.sub[mainId];
  if(!subs) return;
  
  subs.forEach(s => {
    const el = document.createElement('div');
    el.className = 'muscle-card';
    
    // BUILD SVG PROGRAMMATICALLY
    let svgContent = '';
    if(s.svgType && ANATOMY_ICONS[s.svgType]) {
        const iconDef = ANATOMY_ICONS[s.svgType];
        svgContent = `<svg viewBox="0 0 100 100">${iconDef.base}`;
        // Add specific highlight
        if(s.highlight && iconDef[s.highlight]) {
            svgContent += iconDef[s.highlight];
        }
        svgContent += `</svg>`;
    }

    el.innerHTML = `<div class="muscle-icon-svg">${svgContent}</div><span class="muscle-name">${s.name}</span>`;
    el.onclick = () => addExercise(s.name, mainId, 'strength');
    grid.appendChild(el);
  });
}

function addExercise(name, muscleGroup, type) {
  closeMuscleMenu();
  if(type === 'cardio') {
    data[curDay].push({name: name, type: 'cardio', targetTime: 20, done: false});
  } else {
    data[curDay].push({name: name, muscle: muscleGroup, type: 'strength', target: 3, done: 0, reps: 10, weight: 10, skippedChallenge: false, challengeActive: false});
  }
  save(); render();
  setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 100);
}

// CARDIO TIMER
let cardioIntervals = {};
function toggleCardio(i) {
  const display = document.getElementById(`cardio-timer-${i}`);
  if(cardioIntervals[i]) {
    clearInterval(cardioIntervals[i]);
    delete cardioIntervals[i];
    return;
  }
  let totalSecs = (parseFloat(data[curDay][i].targetTime)||10) * 60;
  let elapsed = 0;
  cardioIntervals[i] = setInterval(() => {
    elapsed++;
    let rem = totalSecs - elapsed;
    if(rem <= 0) {
      clearInterval(cardioIntervals[i]);
      delete cardioIntervals[i];
      alert("Ø¹Ø§Ø´ ÙŠØ§ ÙˆØ­Ø´ Ø§Ù„ÙƒØ§Ø±Ø¯ÙŠÙˆ Ø®Ù„Øµ! ğŸ”¥");
    }
    let m = Math.floor(rem / 60);
    let s = rem % 60;
    display.innerText = `${m}:${s<10?'0'+s:s}`;
  }, 1000);
}

// --- NEW CHALLENGE LOGIC ---
let challengeIdx = -1;

function checkRepTrigger(i, val){
  if(val === 12) {
    challengeIdx = i; challengeState = 0;
    
    // Reset modal UI
    document.getElementById('challengeContent').style.display = 'block';
    document.getElementById('challengePlates').classList.remove('visible');
    
    const btn = document.getElementById('btnShatter');
    if(btn) { btn.classList.remove('cracked'); btn.style.visibility='visible'; btn.innerText = "Ù‡ÙƒØ³Ø± Ø§Ù…ÙˆğŸ¥µğŸ¦"; }
    
    const quotes = ["Ø§Ù„ÙˆØ²Ù† Ø¯Ù‡ Ø¨Ù‚Ù‰ Ù„Ø¹Ø¨Ø©!", "ÙˆØ±ÙŠÙ†ÙŠ ØºØ¶Ø¨Ùƒ!", "Ø¥Ø«Ø¨Øª Ø¥Ù†Ùƒ Ø¹Ù†ØªÙŠÙ„!"];
    document.getElementById('challengeQuote').innerText = quotes[Math.floor(Math.random()*quotes.length)];
    
    setTimeout(()=>document.getElementById('modalChallenge').classList.add('open'), 300);
  }
}

function handleShatter(btn) {
  if (challengeState === 0) {
    btn.classList.add('cracked'); 
    challengeState = 1;
    // Hide content, show plates
    setTimeout(() => {
        document.getElementById('challengeContent').style.display = 'none';
        document.getElementById('challengePlates').classList.add('visible');
    }, 400);
  }
}

function confirmChallengeWeight(val) {
    if(challengeIdx === -1) return;
    
    const ex = data[curDay][challengeIdx];
    
    // 1. Save original state
    ex.originalWeight = ex.weight;
    
    // 2. Add weight
    ex.weight += val;
    ex.challengeActive = true;
    ex.reps = 0; // RESET REPS TO 0
    
    save();
    
    // 3. Update DOM instantly
    document.getElementById(`w-text-${challengeIdx}`).innerText = ex.weight;
    document.getElementById(`reps-val-${challengeIdx}`).value = 0; // Update Input
    update1RM(challengeIdx);
    
    // 4. Update Button Row to Split View
    const actionContainer = document.getElementById(`action-container-${challengeIdx}`);
    if(actionContainer) {
        actionContainer.innerHTML = renderActionButtons(ex, challengeIdx, false);
    }

    document.getElementById('modalChallenge').classList.remove('open');
    showToast(`Ø¹Ø§Ø´! Ø²ÙˆØ¯Ù†Ø§ ${val} ÙƒØ¬Ù… ğŸ”¥`);
}

function successChallenge(i) {
    const ex = data[curDay][i];
    ex.challengeActive = false;
    // Keep weight as is, record set normaly
    addSet(i);
    // Revert button to normal state
    const actionContainer = document.getElementById(`action-container-${i}`);
    if(actionContainer) {
        actionContainer.innerHTML = renderActionButtons(ex, i, ex.done >= ex.target);
    }
}

function failChallenge(i) {
    const ex = data[curDay][i];
    
    // Calculate difference from original
    const diff = ex.weight - ex.originalWeight;

    if (diff > 2.5) {
        // CASE: DROP 2.5KG AND TRY AGAIN
        ex.weight -= 2.5;
        save();
        // Update UI
        document.getElementById(`w-text-${i}`).innerText = ex.weight;
        update1RM(i);
        showToast("Ù†Ø²Ù„ØªÙ„Ùƒ 2.5 ÙƒØ¬Ù…ØŒ Ø¬Ø±Ø¨ ØªØ§Ù†ÙŠ! ğŸ’ª");
        // Keep buttons split (Challenge Active)
    } else {
        // CASE: LAST STEP (Only 2.5kg left or originally 2.5kg)
        ex.weight = ex.originalWeight;
        ex.reps = 12; // Reset reps to 12
        ex.challengeActive = false;
        ex.skippedChallenge = true; // Remind next time
        
        save();
        
        // Update UI Instantly
        document.getElementById(`w-text-${i}`).innerText = ex.weight;
        document.getElementById(`reps-val-${i}`).value = 12;
        update1RM(i);
        
        // Revert Button
        const actionContainer = document.getElementById(`action-container-${i}`);
        if(actionContainer) {
            actionContainer.innerHTML = renderActionButtons(ex, i, false);
        }
        
        render(); // Safe to render here to show the badge
        showToast("ÙˆÙ„Ø§ ÙŠÙ‡Ù…ÙƒØŒ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ø¬Ø§ÙŠØ© Ù‡Ù†Ø¬ÙŠØ¨Ù‡Ø§ ğŸ˜‰");
    }
}

function declineChallenge(){ 
    if(challengeIdx !== -1 && data[curDay][challengeIdx]) {
        data[curDay][challengeIdx].skippedChallenge = true;
        save();
        render(); // Re-render to show the badge
    }
    document.getElementById('modalChallenge').classList.remove('open'); 
}

// REST TIMER (POPUP)
let restInterval = null;
let restSeconds = 0;

function startRestTimer() {
  stopRestTimer();
  restSeconds = appSettings.restTime || 180;
  document.getElementById('restTimerPopup').classList.add('visible');
  updateRestDisplay();
  
  restInterval = setInterval(() => {
    restSeconds--;
    if(restSeconds <= 0) {
      stopRestTimer();
      alert("Ø§Ù„Ø±Ø§Ø­Ø© Ø®Ù„ØµØª! ÙŠÙ„Ø§ ğŸ”¥");
    } else {
      updateRestDisplay();
    }
  }, 1000);
}
function stopRestTimer() {
  clearInterval(restInterval);
  document.getElementById('restTimerPopup').classList.remove('visible');
}
function updateRestDisplay() {
  const m = Math.floor(restSeconds / 60);
  const s = restSeconds % 60;
  document.getElementById('rtDisplay').innerText = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
}

// WORKOUT LOGIC
function addSet(i){
  const ex = data[curDay][i];
  if(ex.done < ex.target) {
    ex.done++;
    const gain = (ex.weight * ex.reps) / 25; 
    addXP(gain > 0 ? gain : 5);
    checkPR(ex);
    save(); 
    calculateVolume();
    
    // Direct UI Update
    document.getElementById(`sets-disp-${i}`).innerHTML = `${ex.done} <span style="color:#555">/</span> ${ex.target}`;
    updateProgressBar(i);

    if(ex.done < ex.target) {
       startRestTimer(); 
    }
  } else {
    const c = document.getElementById(`c-${i}`);
    c.style.animation='none'; void c.offsetWidth; c.style.animation='shakeHard 0.3s';
  }
}

function updateProgressBar(i) {
    const ex = data[curDay][i];
    const pct = Math.min(100, (ex.done/ex.target)*100);
    const bar = document.getElementById(`prog-fill-${i}`);
    const card = document.getElementById(`c-${i}`);
    const btn = document.getElementById(`btn-finish-${i}`);

    if(bar) bar.style.width = `${pct}%`;
    
    if(ex.done >= ex.target) {
        card.classList.add('completed');
        if(btn) { btn.classList.add('active'); btn.innerHTML = '<i class="fa-solid fa-check"></i>'; }
        openWizard(i);
    }
}

function checkPR(ex) {
  const name = ex.name.trim();
  const oldRec = personalRecords[name] || 0;
  if (ex.weight > oldRec) {
    personalRecords[name] = ex.weight; save();
    showToast(`ğŸ† Ø±Ù‚Ù… Ù‚ÙŠØ§Ø³ÙŠ Ø¬Ø¯ÙŠØ¯: ${ex.weight}kg!`);
  }
}

// XP & RANKS
function addXP(amount) { userStats.xp += Math.round(amount); updateXPUI(); save(); }
function updateXPUI() {
  let currentRank = RANKS[0];
  for(let i=0; i<RANKS.length; i++) {
    if(userStats.xp >= RANKS[i].limit) { currentRank = RANKS[i]; }
  }
  document.getElementById('xpFill').style.width = '100%'; 
  document.getElementById('rankDisp').innerText = `${currentRank.title} â€¢ ${Math.floor(userStats.xp)} XP`;
}

// WIZARD
function openWizard(i) {
  tempWizardData = { idx: i, rpe: null, form: true };
  document.querySelectorAll('.rpe-btn').forEach(b => b.classList.remove('selected'));
  document.getElementById('btnFormGood').className = 'modal-btn btn-outline';
  document.getElementById('btnFormBad').className = 'modal-btn btn-outline';
  document.getElementById('modalWizard').classList.add('open');
}
function selectRPE(val, btn){ tempWizardData.rpe = val; document.querySelectorAll('.rpe-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); }
function selectForm(v){ tempWizardData.form = v; document.getElementById('btnFormGood').className = v ? 'modal-btn btn-primary' : 'modal-btn btn-outline'; document.getElementById('btnFormBad').className = !v ? 'modal-btn btn-danger' : 'modal-btn btn-outline'; }
function submitWizard(){
  const {idx, rpe} = tempWizardData;
  if(idx>-1) { data[curDay][idx].rpeVal = rpe; save(); render(); }
  document.getElementById('modalWizard').classList.remove('open');
}

// UTILS
function showToast(m){
  const c = document.getElementById('toastContainer');
  const d = document.createElement('div');
  d.className='toast'; d.innerText=m; c.appendChild(d);
  setTimeout(()=>{ d.style.opacity='0'; setTimeout(()=>d.remove(),300) }, 2500);
}

const panel = document.getElementById('panel');
const overlay = document.getElementById('overlay');
function openPanel(){ overlay.classList.add('open'); panel.classList.add('open'); }
function closeAll(){ 
  overlay.classList.remove('open'); panel.classList.remove('open'); 
  document.getElementById('modalChallenge').classList.remove('open');
  document.getElementById('modalWizard').classList.remove('open');
  document.getElementById('modalTips').classList.remove('open');
  document.getElementById('modalMuscle').classList.remove('open');
  document.getElementById('modalPlates').classList.remove('open');
}

function addBulk(){
  for(let i=0; i<5; i++) { data[curDay].push({name:'ØªÙ…Ø±ÙŠÙ† Ø¥Ø¶Ø§ÙÙŠ',type:'strength',target:3,done:0,reps:10,weight:10}); }
  save(); render(); showToast("ØªÙ… Ø¥Ø¶Ø§ÙØ© 5 ØªÙ…Ø§Ø±ÙŠÙ†"); closeAll();
}
function clearAll(){ if(confirm('âš ï¸ Ù‡ØªÙ…Ø³Ø­ ÙƒÙ„ ØªØ§Ø±ÙŠØ®Ùƒ ÙˆÙ…Ø³ØªÙˆØ§Ùƒ.. Ù…ØªØ£ÙƒØ¯ØŸ')) { localStorage.clear(); location.reload(); } }
function del(i){ if(confirm('Ù…Ø³Ø­ Ø§Ù„ØªÙ…Ø±ÙŠÙ†ØŸ')) { data[curDay].splice(i,1); save(); render(); } }

function finishSession(){ 
  if(confirm('Ø®Ù„ØµØª ØªÙ…Ø±ÙŠÙ†ØŸ')) {
    data[curDay].forEach(e => { if(e.done > 0 && e.type !== 'cardio') { e.done = 0; e.rpeVal = null; } });
    userStats.lastLogin = Date.now(); save(); render(); calculateVolume();
    const tip = TIPS[Math.floor(Math.random()*TIPS.length)];
    document.getElementById('tipText').innerText = tip;
    document.getElementById('modalTips').classList.add('open');
  } 
}
function closeTips() { document.getElementById('modalTips').classList.remove('open'); window.scrollTo({top:0, behavior:'smooth'}); }
function addNewDay() { dayNames.push(document.getElementById('newDayName').value||`Day ${dayNames.length+1}`); data.push([]); save(); renderTabs(); switchDay(dayNames.length-1); closeAll(); }
function renameCurrentDay() { const n=prompt("Ø§Ù„Ø§Ø³Ù…:",dayNames[curDay]); if(n){dayNames[curDay]=n;save();renderTabs();closeAll();} }
function deleteCurrentDay() { if(dayNames.length<=1)return; if(confirm("Ù…Ø³Ø­ Ø§Ù„ÙŠÙˆÙ…ØŸ")){dayNames.splice(curDay,1);data.splice(curDay,1);curDay=0;save();renderTabs();render();closeAll();} }

function addEmpty(){ openMuscleMenu(); }

load();
</script>
</body>
</html>
